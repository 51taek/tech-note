## 이벤트 주도 아키텍처

시스템 컴포넌트가 이벤트 메시지를 교환하면서 비동기적으로 서로 커뮤니케이션하는 아키텍처 스타일.

서비스의 엔드포인트를 동기적으로 호출하는 대신, 컴포넌트가 이벤트를 발행해서 시스템 도메인의 변경 사항을 다른 시스템 요소에 알려준다.

이벤트 주도 실행 흐름의 일반적인 예는 **사가 패턴**이다.

EDA는 **서비스 간 통신**을 의미하고, 이벤트 소싱은 **서비스 내부에서 발생하는 것**이다.

---

### 이벤트

- 이벤트는 메시지이지만, *메시지가 반드시 이벤트는 아니다.*

> **이벤트**: 이미 발생한 변화를 설명하는 메시지  
> **커맨드**: 수행되어야 할 작업을 설명하는 메시지

이벤트는 다음 세 가지 유형 중 하나로 분류할 수 있다:

---

### 1) 이벤트 알림(Event Notification)

- 다른 컴포넌트가 반응할 비즈니스 도메인의 변경에 관한 메시지
- 장황하지 않아야 한다
- 민감한 정보가 메시징 인프라를 통해 공유되면 안 된다
- 구독자가 데이터에 접근하기 위한 *추가 권한*이 필요해야 한다
- 여러 명의 동시 구독자 중 한 명만 이벤트를 처리해야 하는 경우, 질의 절차에 비관적 잠금을 적용한다

```json
{
  "type": "marriage-recorded",
  "person-id": "01bdk32",
  "payload": {
    "person-id": "12ab8dk2",
    "details": "/01bdk32/marriage-data"
  }
}

2) 이벤트를 통한 상태 전송(Event-Carried State Transfer, ECST)
구독자에게 제공자의 내부 상태에 대한 변경을 알려줌

이벤트 알림과 달리 ECST는 상태 변경을 반영하는 모든 데이터를 포함

수정된 엔티티의 완전한 스냅샷을 전달
→ 단, 자료구조가 크다면 실제로 수정된 필드만 포함하는 것을 고려

구독자의 상태 캐시(Cache) 역할 가능

{
  "type": "person-details-changed",
  "person-id": "01b9a9a",
  "payload": {
    "new-last-name": "Williams"
  }
}

3) 도메인 이벤트(Domain Event)
이벤트를 설명하는 모든 정보를 포함

사용자가 추가 조치를 하지 않아도 도메인 모델의 의도를 이해할 수 있음

비즈니스 도메인을 모델링하고 설명하기 위한 이벤트

애그리게이트의 상태 자체보다, 수명주기 동안 발생한 비즈니스 이벤트를 나타냄

{
  "type": "married",
  "person-id": "01b9a761",
  "payload": {
    "person-id": "123a123",
    "assumed-partner-last-name": true
  }
}

이벤트 주도 설계 휴리스틱
최악의 상황을 가정하라
네트워크는 느려진다

가장 중요한 순간에 장애가 발생한다

이벤트는 순서대로 도착하지 않는다

이벤트는 중복된다

일관성 있게 이벤트를 전달하는 방법
메시지 안정적 발송 → 아웃박스 패턴 활용

메시지 발송 시 구독자가 중복 제거, 순서 오류 메시지 재정렬 가능하도록 설계

교차 바운디드 컨텍스트 조율에는 사가 패턴, 프로세스 관리자 패턴 활용

퍼블릭 이벤트와 프라이빗 이벤트 구분하기
특히 이벤트 소싱 애그리게이트에서 도메인 이벤트로 세부 정보를 노출하지 않도록 주의

이벤트를 바운디드 컨텍스트의 퍼블릭 인터페이스 일부로 간주

퍼블릭 인터페이스를 설계할 때, 각 이벤트 유형을 적절히 활용

일관성 요구사항 평가
컴포넌트가 **궁극적 일관성(Eventual Consistency)**을 허용한다면 → ECST 메시지 사용

사용자가 제공자의 최신 상태를 반드시 읽어야 한다면 →
알림 메시지 + 최신 상태를 조회하는 후속 질의(Query) 조합을 사용
