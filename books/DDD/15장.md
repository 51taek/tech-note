## 이벤트 주도 아키텍처

시스템 컴포넌트가 이벤트 메시지를 교환하면서 비동기적으로 서로 커뮤니케이션하는 아키텍처 스타일

서비스의 엔드포인트를 동기적으로 호출하는 대신 컴포넌트가 이벤트를 발행해서 시스템 도메인의 변경사항을 다른 시스템 요소에 알려준다

이벤트 주도 실행 흐름의 일반적인 예는 사가패턴이다

EDA는 서비스 간 통신을 의미하고, 이벤트 소싱은 서비스 내부에서 발생하는 것이다.

### 이벤트

- 이벤트는 메시지이지만 메시지가 반드시 이벤트는 아니다.

<aside>
💡

이벤트 : 이미 발생한 변화를 설명하는 메시지

커맨드 : 수행되야 할 작업을 설명하는 메시지

</aside>

- 이벤트는 알림, 상태 전송, 도메인 이벤트의 세가지 유형 중 하나로 분류할 수 있다
    - 이벤트 알림
        - 다른 컴포넌트가 반응할 비즈니스 도메인의 변경에 관한 메시지이다.
        - 장황하지 않아야 함.
        - 민감한 정보가 메시징 인프라를 통해 공유 되는 것을 막아야함.
        - 구독자가 데이터에 접근하기 위해 추가 권한이 필요하게 해야함.
        - 여러 명의 동시 구독자 중에서 한 명의 구독자만 이벤트를 처리해야 하는 경우 질의 절차에 비관적 잠금 방식을 적용할 수 있다.
        
        ```json
        eventNotification = {
        	"type": "marriage-recorded",
        	"person-id": "01bdk32"
        	"payload": {
        		"person-id": "12ab8dk2",
        		"details": "/01bdk32/marriage-data"
        	}
        };
        ```
        
    - 이벤트를 통한 상태 전송
        - 구독자에게 제공자의 내부 상태에 대한 변경사항을 알려줌.
        - 이벤트 알림 메시지와 달리 ECST 메시지는 상태 변경을 반영하는 모든 데이터를 포함한다.
        - 수정된 엔티티 상태에 대한 완전한 스냅샷
            - 규모가 큰 자료구조를 사용하여 처리하는 경우에는 실제로 수정된 필드만 ECST 메시지에 포함하는 것이 합리적이다.
        - 사용자의 상태를 캐싱하는 역할을 할 수 있다
        
        ```json
        ecst ={
        	"type": "person-details-changed",
        	"person-id": "01b9a9a",
        	"payload": {
        		"new-last=name": "Williams"
        	}
        };
        ```
        
    - 도메인 이벤트
        - 도메인 이벤트에는 이벤트를 설명하는 모든 정보를 포함한다. 사용자는 완전한 그림을 얻기 이해 추가 조치를 취할 필요가 없다
        - 도메인 이벤트는 비즈니스 도메인을 모델링하고 설명하기 위한 것
        - 도메인 이베트에 포함된 데이터는 애그리게이트의 상태를 위한 것이 아니라 수명주기 동안 발생한 비즈니스 이벤트를 설명한다
        
        ```json
        "domainEvent": {
        	"type": "married",
        	"person-id": "01b9a761",
        	"payload": {
        		"person-id": "123a123",
        		"assumed-partner-last-name": true
        	}
        };
        ```
        

### 이벤트 주도 설계 휴리스틱

최악의 상황 가정하기

- 네트워크가 느려질 것이다
- 가장 어렵거나 중요한 순간에 장애가 발생한다
- 이벤트가 순서대로 도착하지 않는다
- 이벤트가 중복된다

다음과 같은 방법으로 이벤트가 항상 일관되게 전달해야 한다

- 메시지를 안정적으로 발송하기 위해 아웃박스 패턴을 활용하자
- 메시지를 발송할 때 굳고자가 메시지 중복을 제거하고 순서가 잘못된 메시지를 식별하고 재정렬할 수 있게 하라
- 보상 조치를 발행해야 하느 교차 바운디드 컨텍스트 프로세스를 조율할 떄 사가패턴과 프로세스 관리자 패턴을 활용하라

### 퍼블릭 이벤트와 프라이빗 이벤트를 사용하라

- 특히 이벤트 소싱 애그리게이트에서 도메인 이벤트를 발송할 때 세부 정보를 노출하지 않도록 주의하라
- 이벤트를 바운디드 컨텍스트의 퍼블릭 인터페이스의 내재된 부분으로 취급하라
- 바운디드 컨텍스트의 퍼블릭 인터페이스를 설계할 때 다른 유형의 이벤트를 활용하라

### 일관성 요구사항을 평가하라

- 컴포넌트가 궁극적으로 일관된 데이터를 처리할 수 있는 경우 이벤트를 통한 상태 전송 메시지를 사용한다
- 사용자가 제공자의 마지막으로 변경된 상태를 읽어야 한느 경우 제공자의 최신 상태를 가져오는 후속 질의와 함께 알림 메시지를 발행한다
