## 커뮤니케이션 패턴

### 스테이트리스 모델 변환

- 프록시 패턴을 구현하여 수신과 발신 요청을 삽입하고 소스 모델을 바운디드 컨텍스트의 목표 모델에 매핑한다
- 동기
    - 바운디드 컨텍스트의 코드베이스에 변환 로직을 포함해서 구현 가능
    - 경우에 따라 변환 로직을 API 게이트웨이 패턴과 같은 외부 컴포넌트로 넘기는 것이 더 효율적일 수 있다
    바운디드 컨텍스트 API의 여러 버전을 관리하고 제공할 수 있다
- 비동기
    - 메시지 프록시를 통해 구현할 수 있다
    - 오픈 호스트 서비스를 구현할 때 비동기식 모델 변환은 반드시 필요하다
    - 프라이빗 이벤트와 퍼블릭 이벤트 구분 가능

### 스테이트풀 모델 변환

- 스테이트풀 모델 변환 솔루션 대신 스트림 처리 플랫폼(Kafka, AWS Keneiss) 또는 일괄 처리 솔루션(Apache NiFi, Aws Glue, Spark)를 사용할 수 있다

### 애그리게이트 연동

도메인 이벤트가 데이터베이스의 상태와 다르게 동작할 수 있다

### 아웃 박스 패턴

알고리즘

- 업데이트된 애그리게이트의 상태와 새 도메인 이벤트는 모두 동일한 원자성 트랜잭션으로 커밋된다
- 메시지 릴레이는 데이터베이스에서 새로 커밋된 도메인 이벤트를 가져온다
- 릴레이는 도메인 이벤트를 메시지 버스에 발행한다
- 성공적으로 발행되면 릴레이는 이벤트를 데이터베이스에 발행한 것으로 표시하거나 완전히 삭제한다

---

- 두 개의 테이블에 원자적으로 커밋하고 메시지를 저장하기 위한 전용 테이블을 사용하는 데이터베이스의 기능을 활용하는 것이 좋다
- 발행 릴레이는 풀 기반 또는 푸시 기반으로 새 도메인 이벤트를 가져올 수 있다
- 풀 : 발행자 풀링
    - 릴레이는 발행되지 않은 이벤트에 대해 데이터베이스를 지속해서 질의할 수 있다.
    - 지속적인 풀링으로 인한 디비 부하를 최소화 하려면 적절한 인덱스가 있어야 한다
- 푸시 : 트랜잭션 로그 추적
    - 디비의 기능을 활용하여 새 이벤트가 추가될 때마다 발행 릴레이를 호출할 수 있다
    - 일부 관계형 디비는 디비의 트랜잭션 로그를 추적하여 업데이트/삽입된 레코드에 대한 알림을 받을 수 있다
    - 디비는 커밋된 변경사항을 이벤트 스트림으로 노출하기도 한다
- 아웃박스 패턴은 적어도 한 번은 메시지 배달을 보장한다

### 사가 패턴

- 여러 트랜잭션에 걸쳐 있는 비즈니스 프로세스를 말함
- 핵심 애그리게이트 설계 원칙 중 하나는 각 트랜잭션을 애그리게이트의 단일 인스턴스로 제한하는 것이다
- 관련 컴포넌트에서 발행하는 이벤트를 수신하고 다른 컴포넌트에 후속 커맨드를 발행한다
- 발행 단계 중 하나가 실패하면 사가는 시스템 상태를 일관되게 유지하도록 적절한 보상 조치를 발행하는 일을 담당한다
- 도메인 이벤트 발행의 경우 사가 상태의 전환을 커맨드 실행과 분리하면 프로세스가 어느 단계에서 실패하더라도 커맨드가 안정적으로 실행될 수 있다

### 프로세스 관리자 패턴

- 프로세스 관리자는 시퀀스의 상태를 유지하고 다음 처리 단계를 결정하는 중앙 처리 장치로 정의한다
- 사가에 올바른 동작 과정을 선택하는 if-else 문이 포함되어 있다면 아마도 프로세스 관리자일 것이다
- 프로세스 관리자는 명시적으로 인스턴스화 해야한다. (사가는 암시적으로 인스턴스화 된다)
- 프로세스 관리자는 단일 소스 이벤트에 바인딩될 수 없다
